{# this is to have to macros available that are used for switch port generation #}
{% import "templates/libs.j2" as funcs with context%}
hostname sw-hec{{ hec.hec_nr }}-oob-{{ item.number|string}}
!
snmp-server contact {{ item.snmp.contact}}
snmp-server location {{ item.snmp.location}}
!
{% if hec.is_tacacs %}
ip tacacs source-interface Vlan21
{% else %}
ip radius source-interface Vlan21
{% endif %}
!
logging source-interface Vlan21
!
{{eos_cmd.c_ntp_source}} Vlan21
!
{% if item.type is defined and item.type == 'core' %}
mlag configuration
   domain-id MLAG-oob
!
vlan 4094
   name MLAG_Vlan
!
spanning-tree mst 0-1 priority 28672
!
alias dhcp-off
   10 bash sudo service dhcpd stop
   20 bash sudo service dhcpd status
!
alias dhcp-on
   10 bash sudo cp /mnt/flash/dhcpd.conf /etc/dhcp/
   20 bash sudo service dhcpd start
   30 bash sudo service dhcpd status
!
alias dhcp-status
   10 bash sudo service dhcpd status
   20 bash sudo cat /var/lib/dhcpd/dhcpd.leases
!
{% if item.bgp is defined %}
interface Loopback0
   ip address {{ item.bgp.router_id | ipaddr('address') }}/32
!
router ospf 1
   router-id {{ item.bgp.router_id }}
   passive-interface default
   no passive-interface Vlan4094
   max-lsa 12000
   network 198.19.224.0/30 area 0.0.0.0
   network 198.19.251.0/24 area 0.0.0.0
   network 198.19.249.0/24 area 0.0.0.0
!
router bgp {{ item.bgp.local_asn }}
   router-id {{ item.bgp.router_id }}
{% for peer in item.bgp.peers %}
{% for setting in [ 'route-map ADMIN_MPLS_IN in', 'route-map ADMIN_MPLS_OUT out', 'maximum-routes 12000' ] if peer.remote_asn != item.bgp.local_asn %}
   neighbor {{ peer.ipv4 }} {{ setting }}
{% endfor %}
{% for setting in [ 'remote-as ' + peer.remote_asn|string, 'maximum-routes 12000' ] %}
   neighbor {{ peer.ipv4 }} {{ setting }}
{% endfor %}
{% endfor %}
{% endif %}
!
interface Loopback494
   description !!! DO NOT TOUCH - HSRP tracking interface !!!
!
track 494 interface Loopback494 line-protocol
!
interface Vlan21
   vrrp 21 track 494 decrement 10
!
interface Vlan4094
   ip ospf network point-to-point
!
ip route {{ hec.inband_trans_cvp }}/32 {{ hec.oob_cvp }}
!
ip routing
!
ip prefix-list MATCH_ANY seq 5 permit 0.0.0.0/0 le 32
{% for prefix in hec.admin_mpls %}
ip prefix-list PREF_ADMIN_MPLS seq {{ prefix.sequence }} permit {{ prefix.prefix_mask }}
{% endfor %}
!
route-map ADMIN_MPLS_IN deny 10
   match ip address prefix-list PREF_ADMIN_MPLS
!
route-map ADMIN_MPLS_IN permit 20
   match ip address prefix-list MATCH_ANY
!
route-map ADMIN_MPLS_OUT permit 10
   match ip address prefix-list PREF_ADMIN_MPLS
!
{% endif %}{# end of oob-core specific settings #}
!
{# setting all ports to default access-port with oob vlan 21 #}
interface Ethernet1-46
   switchport access vlan 21
!
{% if item.ports is defined %}
{% for port in item.ports %}
{{ funcs.switchport(port) }}
{% endfor %}
{% endif %}{# end of port generation #}
{% if item.port_channels is defined %}
{% for po in item.port_channels %}
{{ funcs.switchportchannels(po) }}
{% endfor %}
{% endif %}{# end of port-channel generation #}
!
{% if item.type is not defined or item.type != 'core' %}
! === Uplinks to the OOB core switch pair
interface Port-Channel1
   switchport trunk allowed vlan 21
   switchport mode trunk
   port-channel lacp fallback individual
!
interface Ethernet47
   switchport trunk allowed vlan 21
   switchport mode trunk
   channel-group 1 mode active
!
interface Ethernet48
   switchport trunk allowed vlan 21
   switchport mode trunk
   channel-group 1 mode active
!
ip route 0.0.0.0/0 {{ hec.oob_def_gw }}
!
{% endif %}
