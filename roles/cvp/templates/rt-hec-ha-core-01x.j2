{% import "templates/libs.j2" as funcs with context %}
hostname rt-hec{{ hec.hec_nr }}-ha-core-0{{ item.number }}
!
snmp-server contact {{ item.snmp.contact }}
snmp-server location {{ item.snmp.location }}
!
bfd local-address {{ item.loopback1_ip }}
!
{% if item.ports is defined %}
{% for port in item.ports %}
{{ funcs.switchport(port) }}
{% endfor %}
{% endif %}{# end of port generation #}
{% if item.port_channels is defined %}
{% for po in item.port_channels %}
{{ funcs.switchportchannels(po) }}
{% endfor %}
{% endif %}{# end of port-channel generation #}
{% set uplink_ipv4 = funcs.uplink_port_ip(item.spine_port_towards_leaf) %}
{% set nextsubnet = uplink_ipv4.split('.')[0] %}
{% set link_ip = uplink_ipv4.split('.')[1] %}
{% for interface in item.uplinks %}
interface Ethernet{{ interface }}
   description ->sw-hec{{ hec.hec_nr }}-spine-{{ loop.index + 10 }}, {{ item.spine_port_towards_leaf }}
   ip address 10.{{ loop.index + 10 }}.{{ nextsubnet }}.{{ link_ip }}/31
!
{% endfor %}
!
interface Loopback1
   ip address {{ item.loopback1_ip }}/32
   ip address 10.254.200.1/32 secondary
!
interface Loopback900
   ip address {{ item.nwmgmt_ip }}/32
!
interface Management1
   ip address {{ item.oob_ip }}/{{hec.oob_mask}}
!
{% for interface in item.ports %}
{% if interface.id == '26/1' %}
{% set x = interface.ip %}
{% set remote_ha_ip = funcs.ngdr_rmt_ha_intf_ip(x) %}
{% for remote_edge in hec.ngdr_overlay.remote_edge_routers %}
ip route {{ remote_edge.ip }}/32 Ethernet{{ interface.id }} {{ remote_ha_ip }}
{% endfor %}
ip route {{ item.remote_ha_ip }}/32 Ethernet{{ interface.id }} {{ remote_ha_ip }}
{% endif %}
{% endfor %}
!
router bgp 641{{ hec.hec_nr }}.10999
   router-id {{ item.loopback1_ip }}
{% for interface in item.uplinks %}
   neighbor 10.{{ loop.index + 10 }}.{{ nextsubnet }}.{{ link_ip | int -1 }} {{eos_cmd.c_neighbor_peer_group}} PG-SPINE
{% endfor %}

{% for interface in item.ports %}
{% if interface.id == '26/1' %}
{% set x = interface.ip %}
{% set remote_ha_ip = funcs.ngdr_rmt_ha_intf_ip(x) %}
   neighbor {{ remote_ha_ip }} {{eos_cmd.c_neighbor_peer_group}} PG-RMT-HA-ROUTER
   neighbor {{ remote_ha_ip }} description *** BGP to rt-hec{{ hec.ngdr_overlay.remote_hec_nr }}-ha-core-0{{ item.number}} ***
   !
   address-family evpn
      neighbor {{ remote_ha_ip }} activate
{% endif %}
{% endfor %}
{% set myip = item.loopback1_ip %}
{% set ippart = myip.split(".")[3] %}
{% if item.number is search('\da') %}
{% set mydict = [ {'neighbor': 'b', 'ipv4': (myip|ipmath(1))}, {'neighbor': 'c', 'ipv4': (myip|ipmath(2))}, {'neighbor': 'd', 'ipv4': (myip|ipmath(3))} ] %}
{% elif item.number is search('\db') %}
{% set mydict = [ {'neighbor': 'c', 'ipv4': (myip|ipmath(1))}, {'neighbor': 'd', 'ipv4': (myip|ipmath(2))}, {'neighbor': 'a', 'ipv4': (myip|ipmath(-1))} ] %}
{% elif item.number is search('\dc') %}
{% set mydict = [ {'neighbor': 'd', 'ipv4': (myip|ipmath(1))}, {'neighbor': 'a', 'ipv4': (myip|ipmath(-2))}, {'neighbor': 'b', 'ipv4': (myip|ipmath(-1))} ] %}
{% elif item.number is search('\dd') %}
{% set mydict = [ {'neighbor': 'a', 'ipv4': (myip|ipmath(-3))}, {'neighbor': 'b', 'ipv4': (myip|ipmath(-2))}, {'neighbor': 'c', 'ipv4': (myip|ipmath(-1))} ] %}
{% endif %}
{% for n in mydict %}
   neighbor {{ n['ipv4'] }} {{eos_cmd.c_neighbor_peer_group}} PG-HA-ROUTER
   neighbor {{ n['ipv4'] }} description *** EVPN to rt-hec{{ hec.hec_nr }}-ha-core-01{{ n['neighbor'] }} ***
   !
   address-family evpn
      neighbor {{ n['ipv4'] }} activate
   !
{% endfor %}
{% if hec.fabric.vtep_distribution_mode == "evpn" %}
   !
   vlan-aware-bundle all-vlans
      rd {{ item.loopback1_ip }}:1
   !
{% endif %}
   address-family ipv4
{% for interface in item.uplinks %}
      neighbor 10.{{ loop.index + 10 }}.{{ nextsubnet }}.{{ link_ip | int -1 }} activate
{% endfor %}
      network 10.254.200.1/32
      network {{ item.nwmgmt_ip }}/32
      network {{ item.remote_ha_ip }}/32
      network {{ item.loopback1_ip }}/32
   !
!
